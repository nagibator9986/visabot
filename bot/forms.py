# forms.py
import logging
import sqlite3
from datetime import datetime

logger = logging.getLogger("visa_bot.forms")


# ---------- HTML-анкеты, которые бот вставляет в письмо ----------

def generate_form_html(form_type: str) -> str:
    """
    form_type: 'poland', 'schengen', 'usa'
    Возвращает HTML-текст анкеты, которую бот отправит клиенту по почте.
    Клиент просто отвечает на письмо и заполняет вопросы по пунктам.
    """
    form_type = (form_type or "").lower()

    if form_type == "poland":
        title = "Анкета для визы в Польшу"
        intro = (
            "Пожалуйста, ответьте на вопросы ниже прямо в теле письма. "
            "Оставляйте номера вопросов и пишите ответы после двоеточия."
        )
        questions = [
            "1. Фамилия и имя (как в загранпаспорте, латиницей)",
            "2. Дата рождения (дд.мм.гггг)",
            "3. Гражданство",
            "4. Номер загранпаспорта, дата выдачи, кем выдан, срок действия",
            "5. Домашний адрес и город проживания",
            "6. Контактный телефон и e-mail",
            "7. Цель поездки (учёба/работа/туризм/другое)",
            "8. Планируемые даты поездки (въезд — выезд)",
            "9. Есть ли приглашение? Если да — кем выдано (организация/лицо, город)",
            "10. Были ли у вас ранее визы в страны Шенгена? Если да — какие и когда",
        ]

    elif form_type == "schengen":
        title = "Анкета для шенгенской визы (Франция/Италия и др.)"
        intro = (
            "Пожалуйста, заполните анкету ниже. Отвечайте по пунктам, не пропуская вопросы. "
            "Номера вопросов сохраняйте."
        )
        questions = [
            "1. Фамилия и имя (как в загранпаспорте, латиницей)",
            "2. Дата и место рождения",
            "3. Гражданство (основное и, при наличии, второе)",
            "4. Номер загранпаспорта, дата выдачи, кем выдан, срок действия",
            "5. Домашний адрес, индекс, город и страна",
            "6. Номер мобильного телефона и e-mail",
            "7. Основная цель поездки (туризм/бизнес/гости/другое)",
            "8. Планируемые даты поездки и длительность (кол-во дней)",
            "9. Страна первого въезда и основная страна пребывания",
            "10. Были ли ранее шенгенские визы? Если да — какие, когда и на какой срок",
            "11. Информация о работе: должность, название компании, адрес, телефон",
        ]

    elif form_type == "usa":
        title = "Анкета для визы США (краткая версия для сбора данных)"
        intro = (
            "Ниже — сокращённая версия опросника для визы США. "
            "Пожалуйста, отвечайте максимально подробно. "
            "Полный перечень вопросов (как ты присылал) мы можем потом развернуть, "
            "но сейчас нам важно начать структурированный сбор данных."
        )
        questions = [
            # Personal Information
            "1. Фамилия и имя (латиницей, как в загранпаспорте)",
            "2. Были ли другие фамилии/имена (в том числе девичья фамилия)? Если да — перечислите.",
            "3. Семейное положение",
            "4. Дата рождения (дд.мм.гггг)",
            "5. Место рождения (город, страна)",
            "6. Гражданство(а) в настоящий момент",
            "7. Есть ли другое (предыдущее) гражданство? Если да — какое/какие.",
            "8. Являетесь ли постоянным резидентом другой страны? Если да — какой.",
            "9. ИИН (национальный идентификационный номер)",

            # Travel info
            "10. Цель поездки в США (туризм/бизнес/гости/другое)",
            "11. Планируемая дата приезда и выезда (дд.мм.гггг — дд.мм.гггг)",
            "12. Предполагаемая продолжительность пребывания (кол-во дней/недель)",
            "13. Город и адрес предполагаемого проживания (отель/адрес приглашающей стороны)",
            "14. Кто оплачивает поездку (вы/работодатель/родственник/другое)? Укажите ФИО/организацию, телефон, e-mail.",
            "15. Путешествуют ли с вами другие люди? Если да — ФИО и кем приходятся.",
            "16. Были ли вы ранее в США? Если да — когда, на какой срок, по какой визе.",
            "17. Была ли у вас виза США ранее? Если да — укажите год и категорию (B1/B2 и т.д.).",

            # Contacts
            "18. Домашний адрес (страна, город, улица, дом, квартира, индекс)",
            "19. Основной номер телефона, дополнительные номера за 5 лет (если были)",
            "20. Основной e-mail и дополнительные e-mail за последние 5 лет",
            "21. Активные социальные сети (Instagram, Facebook, LinkedIn и др.) и ссылки на профили",

            # Passport
            "22. Номер загранпаспорта, дата выдачи, кем выдан, срок действия",
            "23. Был ли когда-либо утерян или украден паспорт? Если да — когда и при каких обстоятельствах.",

            # Work / Education
            "24. Текущая работа: должность, название компании, адрес, телефон, дата начала работы, месячный доход.",
            "25. Кратко опишите ваши обязанности на текущей работе.",
            "26. Предыдущие места работы за последние 10 лет (если были): период, должность, компания, адрес.",
            "27. Образование: учебные заведения (колледж/университет), специальность, годы обучения.",

            # Дополнительно (суммарно по блоку «Security and Background»)
            "28. Посещали ли вы другие страны за последние 5 лет? Укажите список стран и примерные даты.",
            "29. Есть ли у вас близкие родственники в США (кроме родителей)? Если да — кто, статус, где проживают.",
            "30. Были ли когда-либо отказы в визе (США или другие страны), депортация, серьёзные правонарушения, судимости, "
            "участие в военной/военизированной службе и т.п.? Если да — опишите.",
        ]

    else:
        # На всякий случай — если тип не распознан
        title = "Анкета"
        intro = (
            "Пожалуйста, заполните ответы по пунктам. "
            "Если вы видите это сообщение, значит тип анкеты не был указан."
        )
        questions = [
            "1. Фамилия и имя",
            "2. Контактный телефон",
            "3. E-mail",
            "4. Страна, по которой вы хотите оформить визу",
            "5. Кратко опишите вашу ситуацию и цель поездки",
        ]

    # Формируем HTML (без тяжёлого дизайна — Outlook всё равно всё упростит)
    q_html = "".join(f"<li>{q}</li>" for q in questions)
    html = f"""
    <div>
      <h3>{title}</h3>
      <p>{intro}</p>
      <ol>
        {q_html}
      </ol>
      <p><strong>Важно:</strong> отвечайте на это письмо, не создавая новое, чтобы мы могли связать ответы с вашей заявкой.</p>
    </div>
    """
    return html.strip()


# ---------- Сохранение ответов анкеты в базу leads.db ----------

def _ensure_forms_table(conn: sqlite3.Connection):
    """
    Создаёт таблицу lead_forms, если её ещё нет.
    Здесь мы храним сырые ответы клиента по анкетам (Польша, Шенген, США).
    """
    cur = conn.cursor()
    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS lead_forms (
            id INTEGER PRIMARY KEY,
            lead_id INTEGER,
            form_type TEXT,
            raw_text TEXT,
            created_at TEXT DEFAULT (datetime('now'))
        )
        """
    )
    conn.commit()


def _detect_form_type_from_text(text: str) -> str:
    """
    Очень простой детектор типа анкеты по содержимому письма.
    Можно расширять правила при необходимости.
    """
    t = (text or "").lower()

    if "польш" in t or "poland" in t:
        return "poland"
    if "шенген" in t or "france" in t or "итал" in t or "italy" in t:
        return "schengen"
    if "сша" in t or "usa" in t or "u.s." in t:
        return "usa"

    return "unknown"


def handle_form_answers_if_any(*args, **kwargs) -> bool:
    """
    Гибкая функция, чтобы не ломаться, даже если её вызывают с разной сигнатурой.

    Ожидаемые варианты (но не строго):
        handle_form_answers_if_any(conn, lead_row, message_text)
        handle_form_answers_if_any(conn=..., lead=..., message_text=...)

    Делает:
      1. Если нет текста или соединения с БД — просто возвращает False (ничего не делает).
      2. Создаёт таблицу lead_forms при необходимости.
      3. Определяет примерный тип анкеты (Польша / Шенген / США / unknown).
      4. Сохраняет исходный текст ответов в таблицу lead_forms.
    """
    conn = kwargs.get("conn")
    lead = kwargs.get("lead")
    message_text = kwargs.get("message_text") or kwargs.get("body")

    # Попытка выцепить из позиционных аргументов
    if conn is None and len(args) >= 1 and isinstance(args[0], sqlite3.Connection):
        conn = args[0]
    if lead is None and len(args) >= 2:
        lead = args[1]
    if message_text is None and len(args) >= 3 and isinstance(args[2], str):
        message_text = args[2]

    if conn is None:
        logger.debug("handle_form_answers_if_any: нет соединения с БД, пропускаем сохранение анкеты")
        return False

    if not message_text or not message_text.strip():
        # Нечего сохранять
        return False

    try:
        _ensure_forms_table(conn)
    except Exception as e:
        logger.exception("Не удалось создать/обновить таблицу lead_forms: %s", e)
        return False

    # lead_id берём из sqlite Row или словаря, если есть
    lead_id = None
    try:
        if isinstance(lead, sqlite3.Row):
            lead_id = lead.get("id") if hasattr(lead, "get") else lead["id"]
        elif isinstance(lead, dict):
            lead_id = lead.get("id") or lead.get("lead_id")
    except Exception:
        # если что-то не так — просто оставляем lead_id=None
        pass

    form_type = _detect_form_type_from_text(message_text)
    created_at = datetime.utcnow().isoformat(timespec="seconds")

    try:
        cur = conn.cursor()
        cur.execute(
            "INSERT INTO lead_forms (lead_id, form_type, raw_text, created_at) VALUES (?, ?, ?, ?)",
            (lead_id, form_type, message_text, created_at),
        )
        conn.commit()
        logger.info(
            "Сохранены ответы анкеты: lead_id=%s, form_type=%s, length=%d",
            lead_id,
            form_type,
            len(message_text),
        )
        return True
    except Exception as e:
        logger.exception("Ошибка при сохранении ответов анкеты в lead_forms: %s", e)
        return False
